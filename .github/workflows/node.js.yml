name: Build and Run React Native Android App with Dependency Update, Emulator Options, and File Handling

on:
  # Define when the workflow should be triggered (e.g., on pushes to the main branch)
  push:
    branches: [ main ]

jobs:
  build-and-run:
    runs-on: ubuntu-latest  # Replace with your preferred OS (adjust if needed)

    steps:
      - uses: actions/checkout@v4  # Checkout code from repository

      # Upgrade JRE (if needed)
      - name: Check JRE version
        run: |
          java -version
          if [[ $? -ne 0 ]]; then
            echo "WARNING: Java not found. Installing OpenJDK 17..."
          elif [[ $(java -version 2>&1 | grep -w version | awk '{print $3}') < "17" ]]; then
            echo "WARNING: Detected JRE version below 17. Upgrading to OpenJDK 17..."
          else
            echo "JRE version 17 or higher detected. Skipping upgrade."
            exit 0  # Exit step if JRE is already compatible
          fi

      - name: Install OpenJDK 17 (if needed)
        uses: actions/setup-java@v3
        with:
          distribution: 'adopt'  # Installs OpenJDK from Adoptium
          java-version: '17'  # Specify desired Java version (adjust if needed)
          # Consider adding `cache: 'maven'` to cache downloaded OpenJDK packages

      - name: Install dependencies
        run: npm install  # Or yarn install

      # Update outdated dependencies
      - name: Update dependencies
        run: |
          npm update expo-router expo-splash-screen react-native-maps

      # Verify JRE upgrade (optional)
      - name: Verify JRE version after upgrade
        run: java -version  # Optional step to confirm successful JRE upgrade

      # Install Android SDK using the recommended action
      - uses: android-actions/setup-android@v3

      # Verify $ANDROID_HOME is properly set for later Gradle commands.
      - name: Verify ANDROID_HOME
        run: echo $ANDROID_HOME

      # Choose between emulator or device connection:

        - name: Connect Android Device (if available)
          # Replace with your preferred method for checking device connection
          run: |
            # Example using adb:
            if [[ $(adb devices | grep -c device) -gt 0 ]]; then
              echo "Android device found. Skipping emulator startup."
              exit 0
            fi

        - name: Start emulator using Android Studio (if installed)
          run: |
            if [[ -d /home/runner/android-studio ]]; then
              /home/runner/android-studio/bin/studio.sh -t emulator @Pixel_3_API_30_XL
            else
              echo "WARNING: Android Studio not found. Skipping emulator startup."
            fi

      # **File Handling Options (Choose one based on your need):**

        # 1. Download a file from a previous workflow run or another repository:
        # - uses: actions/download-artifact@v2
        #   with:
        #     name: my-artifact  # Name of the artifact containing the file
        #     path: /path/to/download/location  # Where to download the file on the runner machine

        # 2. Upload a generated file as an artifact:
        # - uses: actions/upload-artifact@v3
        #   with:
        #     name: android-release.aab  # Name of the artifact (adjust as needed)
        #     path: android/app/build/outputs/bundle/release/app-release.aab  # Path to the file (adjust as needed)

        # 3. Generate a file from a template (replace with your specific commands):
        # - name: Generate file from template
        #   run: |
        #     cat template.txt | sed 's/placeholder/value/g' > new_file.txt

      # Build and run the Android app
      - name: Run expo start --android
        run: expo start --android
